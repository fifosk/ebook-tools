# ebook-tools â€” Local Docker Deployment
#
# All containers run on the same Mac Mini, managed via Docker Desktop.
# Volumes mount directly from the project repo.
#
# Usage:
#   docker compose up -d            # start all services
#   docker compose logs -f          # follow logs
#   docker compose down             # stop all services
#   docker compose up -d --build    # rebuild and restart

services:
  postgres:
    image: postgres:16-alpine
    container_name: ebook-tools-postgres
    restart: unless-stopped
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - /Volumes/Data/Databases/ebook-tools/postgres:/var/lib/postgresql/data
      - /Volumes/Backups/ebook-tools/postgres:/backups
    environment:
      - POSTGRES_DB=ebook_tools
      - POSTGRES_USER=ebook_tools
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ebook_tools_dev}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ebook_tools -d ebook_tools"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: >
      postgres
        -c shared_buffers=256MB
        -c effective_cache_size=512MB
        -c work_mem=16MB
        -c maintenance_work_mem=64MB
        -c max_connections=50

  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    image: ebook-tools-backend:latest
    container_name: ebook-tools-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./storage:/app/storage
      - ./config/users:/app/config/users
      - ./conf/config.local.json:/app/conf/config.local.json:ro
      - ./.env.local:/app/.env.local:ro
      - ./conf/certs:/app/conf/certs:ro
      - ./log:/app/log
      - /Volumes/Data/Download/Ebooks:/app/nas/ebooks:ro
      - /Volumes/Data/Download/DStation:/app/nas/videos
      - /Volumes/Data/Download/Subtitles:/app/nas/subtitles
    tmpfs:
      - /app/tmp:size=1G
    environment:
      - EBOOK_API_CORS_ORIGINS=https://api.langtools.fifosk.synology.me https://langtools.fifosk.synology.me http://localhost:5173
      - EBOOK_API_STATIC_ROOT=
      - EBOOK_TTS_BACKEND=gtts
      - EBOOK_USE_RAMDISK=false
      - EBOOK_STORAGE_BASE_URL=https://api.langtools.fifosk.synology.me/storage/jobs
      - JOB_STORAGE_DIR=/app/storage
      - EBOOK_LIBRARY_ROOT=/app/storage/library
      - EBOOK_EBOOKS_DIR=/app/nas/ebooks
      - YOUTUBE_VIDEO_ROOT=/app/nas/videos
      - SUBTITLE_SOURCE_DIR=/app/nas/subtitles
      # Override macOS-specific ML model paths from .env.local (use container defaults)
      - EBOOK_PIPER_MODELS_PATH=
      - EBOOK_WHISPERX_MODELS_PATH=
      - EBOOK_HF_CACHE_PATH=
      # PostgreSQL connection
      - DATABASE_URL=postgresql+psycopg2://ebook_tools:${POSTGRES_PASSWORD:-ebook_tools_dev}@postgres:5432/ebook_tools
    env_file:
      - path: .env.docker
        required: false
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/_health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      args:
        VITE_API_BASE_URL: https://api.langtools.fifosk.synology.me
        VITE_STORAGE_BASE_URL: https://api.langtools.fifosk.synology.me/storage/jobs
        VITE_GOOGLE_CLIENT_ID: "930231338560-c1o7malc7s7v4clg5mm4v7du0l032cm2.apps.googleusercontent.com"
        VITE_APPLE_CLIENT_ID: "com.example.interactivereader.web"
        VITE_APPLE_REDIRECT_URI: "https://langtools.fifosk.synology.me/auth/apple/callback"
    image: ebook-tools-frontend:latest
    container_name: ebook-tools-frontend
    restart: unless-stopped
    ports:
      - "5173:80"
    environment:
      - BACKEND_HOST=backend
    depends_on:
      backend:
        condition: service_healthy

  pg-backup:
    image: postgres:16-alpine
    container_name: ebook-tools-pg-backup
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - /Volumes/Backups/ebook-tools/postgres:/backups
    environment:
      - PGHOST=postgres
      - PGUSER=ebook_tools
      - PGDATABASE=ebook_tools
      - PGPASSWORD=${POSTGRES_PASSWORD:-ebook_tools_dev}
    entrypoint: /bin/sh
    command: >
      -c "while true; do
        BACKUP_FILE=/backups/ebook_tools_$$(date +%Y%m%d_%H%M%S).sql.gz;
        pg_dump | gzip > $$BACKUP_FILE;
        echo \"Backup created: $$BACKUP_FILE\";
        find /backups -name '*.sql.gz' -mtime +7 -delete;
        echo 'Cleaned backups older than 7 days';
        sleep 86400;
      done"
