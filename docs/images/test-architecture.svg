<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="720" viewBox="0 0 1200 720">
  <style>
    text { font-family: -apple-system, 'Segoe UI', Helvetica, Arial, sans-serif; fill: #1a1a1a; }
    .title { font-size: 20px; font-weight: 600; }
    .layer-label { font-size: 12px; font-weight: 600; }
    .box-label { font-size: 11px; font-weight: 500; }
    .box-sub { font-size: 10px; fill: #555; }
    .small { font-size: 9px; fill: #666; }
    rect, .rr { rx: 6; ry: 6; }
  </style>
  <defs>
    <marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#4b5563" />
    </marker>
    <marker id="ah-green" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#82b366" />
    </marker>
    <marker id="ah-yellow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#d6b656" />
    </marker>
    <marker id="ah-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#b85450" />
    </marker>
    <marker id="ah-gray" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#666" />
    </marker>
    <marker id="ah-purple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#996185" />
    </marker>
  </defs>

  <!-- Title -->
  <text class="title" x="30" y="32">ebook-tools â€” Test Architecture</text>

  <!-- ===== TEST SUITE HEADER ===== -->
  <rect x="380" y="50" width="440" height="50" fill="#dae8fc" stroke="#6c8ebf" stroke-width="1.5" />
  <text class="box-label" x="490" y="72" font-size="14" font-weight="600">Test Suite</text>
  <text class="box-sub" x="468" y="90">801+ tests  |  16 markers  |  pytest</text>

  <!-- ===== ARROWS: Suite to layers ===== -->
  <!-- Suite to Unit Tests -->
  <path d="M 500 100 L 500 120 L 220 120 L 220 148" stroke="#82b366" stroke-width="1.5" fill="none" marker-end="url(#ah-green)" />
  <!-- Suite to Integration Tests -->
  <line x1="600" y1="100" x2="600" y2="148" stroke="#d6b656" stroke-width="1.5" marker-end="url(#ah-yellow)" />
  <!-- Suite to E2E Tests (dashed) -->
  <path d="M 500 100 L 500 120 L 400 120 L 400 415 L 400 428" stroke="#b85450" stroke-width="1.5" fill="none" stroke-dasharray="5 3" marker-end="url(#ah-red)" />
  <text class="small" x="405" y="280">on-demand</text>
  <!-- Suite to Reports -->
  <path d="M 820 75 L 860 75 L 860 148" stroke="#666" stroke-width="1.5" fill="none" marker-end="url(#ah-gray)" />

  <!-- ===== UNIT TESTS ===== -->
  <rect x="30" y="150" width="380" height="245" fill="#e8f5e0" stroke="#82b366" stroke-width="1.5" />
  <text class="layer-label" x="45" y="172" fill="#2d6a2d">Unit Tests (per-module)</text>

  <!-- Row 1 -->
  <rect x="45" y="185" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="63" y="204">webapi</text>
  <rect x="135" y="185" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="158" y="204">audio</text>
  <rect x="225" y="185" width="85" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="237" y="204">translation</text>
  <rect x="320" y="185" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="337" y="204">services</text>

  <!-- Row 2 -->
  <rect x="45" y="225" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="74" y="244">cli</text>
  <rect x="135" y="225" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="159" y="244">auth</text>
  <rect x="225" y="225" width="85" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="249" y="244">config</text>
  <rect x="320" y="225" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="342" y="244">media</text>

  <!-- Row 3 -->
  <rect x="45" y="265" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="60" y="284">ramdisk</text>
  <rect x="135" y="265" width="90" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="141" y="284">lookup_cache</text>
  <rect x="235" y="265" width="80" height="30" fill="#fff" stroke="#82b366" stroke-width="1" />
  <text class="box-sub" x="249" y="284">subtitles</text>

  <!-- Unit description -->
  <text class="small" x="45" y="318">Fast, isolated, no external deps</text>
  <text class="small" x="45" y="333">Run:  pytest -m &lt;marker&gt;</text>
  <text class="small" x="45" y="348">Quick:  make test-fast</text>
  <text class="small" x="45" y="363">Full:  make test</text>

  <!-- ===== INTEGRATION TESTS ===== -->
  <rect x="430" y="150" width="370" height="245" fill="#fef9e7" stroke="#d6b656" stroke-width="1.5" />
  <text class="layer-label" x="445" y="172" fill="#8b6d1a">Integration Tests</text>

  <!-- Row 1 -->
  <rect x="445" y="185" width="80" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="460" y="204">pipeline</text>
  <rect x="535" y="185" width="80" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="556" y="204">render</text>
  <rect x="625" y="185" width="85" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="639" y="204">metadata</text>
  <rect x="720" y="185" width="70" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="737" y="204">library</text>

  <!-- Row 2 -->
  <rect x="445" y="225" width="115" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="454" y="244">CJK tokenization</text>
  <rect x="570" y="225" width="120" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="578" y="244">WhisperX alignment</text>

  <!-- Row 3 -->
  <rect x="445" y="265" width="130" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="454" y="284">Piper + WhisperX</text>
  <rect x="585" y="265" width="120" height="30" fill="#fff" stroke="#d6b656" stroke-width="1" />
  <text class="box-sub" x="594" y="284">word timing valid.</text>

  <!-- Integration description -->
  <text class="small" x="445" y="318">May need external services (LLM, TTS)</text>
  <text class="small" x="445" y="333">Run:  pytest -m integration</text>
  <text class="small" x="445" y="348">Slow:  pytest -m slow</text>

  <!-- ===== E2E TESTS ===== -->
  <rect x="30" y="430" width="770" height="255" fill="#fde8e8" stroke="#b85450" stroke-width="1.5" />
  <text class="layer-label" x="45" y="452" fill="#8b3a36">E2E Tests (on-demand, 4 platforms)</text>

  <!-- Web Platform -->
  <rect x="50" y="468" width="160" height="48" fill="#fff" stroke="#b85450" stroke-width="1.5" />
  <text class="box-label" x="86" y="489">Web</text>
  <text class="box-sub" x="76" y="507">(Playwright)</text>
  <text class="small" x="50" y="532">Python runner</text>
  <text class="small" x="50" y="545">Headless / headed</text>
  <text class="small" x="50" y="558">Auth via localStorage</text>

  <!-- iPhone Platform -->
  <rect x="230" y="468" width="135" height="48" fill="#fff" stroke="#b85450" stroke-width="1.5" />
  <text class="box-label" x="260" y="489">iPhone</text>
  <text class="box-sub" x="257" y="507">(XCUITest)</text>
  <text class="small" x="230" y="532">Swift runner</text>
  <text class="small" x="230" y="545">iPhone 17 Pro sim</text>
  <text class="small" x="230" y="558">Edge swipe back</text>

  <!-- iPad Platform -->
  <rect x="385" y="468" width="135" height="48" fill="#fff" stroke="#b85450" stroke-width="1.5" />
  <text class="box-label" x="424" y="489">iPad</text>
  <text class="box-sub" x="413" y="507">(XCUITest)</text>
  <text class="small" x="385" y="532">Swift runner</text>
  <text class="small" x="385" y="545">iPad Air 11" sim</text>
  <text class="small" x="385" y="558">Edge swipe back</text>

  <!-- tvOS Platform -->
  <rect x="540" y="468" width="135" height="48" fill="#fff" stroke="#b85450" stroke-width="1.5" />
  <text class="box-label" x="576" y="489">tvOS</text>
  <text class="box-sub" x="567" y="507">(XCUITest)</text>
  <text class="small" x="540" y="532">Swift runner</text>
  <text class="small" x="540" y="545">Apple TV sim</text>
  <text class="small" x="540" y="558">Menu button back</text>

  <!-- Shared Journeys -->
  <rect x="160" y="590" width="450" height="40" fill="#f3e8ef" stroke="#996185" stroke-width="1.5" />
  <text class="box-label" x="260" y="608">Shared JSON Journeys</text>
  <text class="box-sub" x="257" y="624">tests/e2e/journeys/*.json</text>

  <!-- Arrows: Journeys to all platforms -->
  <line x1="250" y1="590" x2="130" y2="518" stroke="#996185" stroke-width="1.3" marker-end="url(#ah-purple)" />
  <line x1="330" y1="590" x2="298" y2="518" stroke="#996185" stroke-width="1.3" marker-end="url(#ah-purple)" />
  <line x1="440" y1="590" x2="452" y2="518" stroke="#996185" stroke-width="1.3" marker-end="url(#ah-purple)" />
  <line x1="520" y1="590" x2="608" y2="518" stroke="#996185" stroke-width="1.3" marker-end="url(#ah-purple)" />

  <!-- E2E description -->
  <text class="small" x="50" y="660">Requires running API  +  credentials in .env</text>
  <text class="small" x="50" y="675">Run:  make test-e2e-all  (sequential, -j4 corrupts xcresult)</text>

  <!-- ===== REPORTS ===== -->
  <rect x="830" y="150" width="340" height="245" fill="#f5f5f5" stroke="#666" stroke-width="1.5" />
  <text class="layer-label" x="845" y="172" fill="#444">Reports</text>

  <rect x="845" y="188" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="860" y="206">Terminal Output</text>
  <text class="small" x="860" y="220">(pytest stdout)</text>

  <rect x="1005" y="188" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="1020" y="206">Coverage Report</text>
  <text class="small" x="1020" y="220">(--cov=modules)</text>

  <rect x="845" y="245" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="860" y="263">Markdown Reports</text>
  <text class="small" x="860" y="277">(test-results/*.md)</text>

  <rect x="1005" y="245" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="1020" y="263">Screenshots</text>
  <text class="small" x="1020" y="277">(per-platform prefix)</text>

  <rect x="845" y="302" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="860" y="320">xcresult Bundles</text>
  <text class="small" x="860" y="334">(iOS/tvOS)</text>

  <!-- E2E to Reports (dashed) -->
  <path d="M 800 550 L 860 550 L 860 395" stroke="#666" stroke-width="1.3" fill="none" stroke-dasharray="5 3" marker-end="url(#ah-gray)" />

  <!-- ===== TEST INFRASTRUCTURE ===== -->
  <rect x="830" y="430" width="340" height="255" fill="#f5f5f5" stroke="#666" stroke-width="1.5" />
  <text class="layer-label" x="845" y="452" fill="#444">Test Infrastructure</text>

  <rect x="845" y="465" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="860" y="483">conftest.py</text>
  <text class="small" x="860" y="497">(session fixtures)</text>

  <rect x="1005" y="465" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="1020" y="483">helpers/</text>
  <text class="small" x="1020" y="497">(PipelineInput stubs)</text>

  <rect x="845" y="522" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="860" y="540">report.py</text>
  <text class="small" x="860" y="554">(Markdown plugin)</text>

  <rect x="1005" y="522" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="1020" y="540">ios_e2e_report.py</text>
  <text class="small" x="1020" y="554">(xcresult parser)</text>

  <rect x="845" y="579" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="860" y="597">RAMDisk patch</text>
  <text class="small" x="860" y="611">(no-op in tests)</text>

  <rect x="1005" y="579" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="1020" y="597">HuggingFace cache</text>
  <text class="small" x="1020" y="611">(external SSD)</text>

  <rect x="845" y="636" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="860" y="654">stubs/</text>
  <text class="small" x="860" y="668">(optional dep shims)</text>

  <rect x="1005" y="636" width="145" height="40" fill="#fff" stroke="#666" stroke-width="1" />
  <text class="box-sub" x="1020" y="654">bruno/</text>
  <text class="small" x="1020" y="668">(manual API testing)</text>
</svg>
