from __future__ import annotations

import subprocess  # Exposed for test monkeypatching

from modules.subtitles.render import _SubtitleFileWriter

from .audio_utils import (
    _apply_audio_gain_to_clip,
    _apply_gap_audio_mix,
    _build_atempo_filters,
    _clamp_original_mix,
    _coerce_channels,
    _compute_reference_rms,
    _compute_underlay_gain_db,
    _fit_segment_to_window,
    _has_audio_stream,
    _measure_active_window,
    _mix_with_original_audio,
    _resolve_gap_mix_percent,
    _sanitize_for_tts,
    _synthesise_track_from_ass,
    _time_stretch_to_duration,
    logger as _audio_logger,
)
from .common import (
    DEFAULT_YOUTUBE_VIDEO_ROOT,
    _DEFAULT_FLUSH_SENTENCES,
    _DEFAULT_ORIGINAL_MIX_PERCENT,
    _GAP_MIX_MAX_PERCENT,
    _GAP_MIX_SCALAR,
    _LANGUAGE_TOKEN_PATTERN,
    _MIN_DIALOGUE_DURATION_SECONDS,
    _MIN_DIALOGUE_GAP_SECONDS,
    _SUBTITLE_EXTENSIONS,
    _SUBTITLE_MIRROR_DIR,
    _TARGET_DUB_HEIGHT,
    _TEMP_DIR,
    _VIDEO_EXTENSIONS,
    _AssDialogue,
    _DubJobCancelled,
    YoutubeNasSubtitle,
    YoutubeNasVideo,
    logger,
)
from .dialogues import (
    _ASS_TAG_PATTERN,
    _HTML_TAG_PATTERN,
    _clip_dialogues_to_window,
    _compute_pace_factor,
    _cues_to_dialogues,
    _enforce_dialogue_gaps,
    _extract_translation,
    _merge_overlapping_dialogues,
    _normalize_ass_line,
    _normalize_dialogue_windows,
    _parse_ass_dialogues,
    _parse_ass_timestamp,
    _parse_batch_start_seconds,
    _parse_dialogues,
    _seconds_to_vtt_timestamp,
    _validate_time_window,
)
from .generation import generate_dubbed_video
from .language import (
    _find_language_token,
    _is_rtl_language,
    _language_uses_non_latin,
    _normalize_language_hint,
    _normalize_rtl_word_order,
    _resolve_language_code,
    _transliterate_text,
)
from .nas import (
    SubtitleDeletionResult,
    delete_downloaded_video,
    extract_inline_subtitles,
    delete_nas_subtitle,
    list_inline_subtitle_streams,
    list_downloaded_videos,
    _build_subtitle_output_path,
    _language_matches_filters,
    _mirror_subtitle_to_source_dir,
    _normalize_all_caps_cues,
    _normalize_language_filters,
    _probe_subtitle_streams,
    _sanitize_cue_markup,
    _sanitize_subtitle_text,
    _subtitle_codec_is_image_based,
    _sentence_case_line,
    _summarize_ffmpeg_error,
    _looks_all_caps,
)
from .service import (
    YoutubeDubbingService,
    _build_job_result,
    _run_dub_job,
    _serialize_generated_files,
    _serialize_generated_files_batch,
)
from .video_utils import (
    _classify_video_source,
    _concat_video_segments,
    _format_clip_suffix,
    _format_time_prefix,
    _has_video_stream,
    _mux_audio_track,
    _pad_clip_to_duration,
    _probe_duration_seconds,
    _probe_video_height,
    _resolve_batch_output_path,
    _resolve_output_path,
    _resolve_target_width,
    _resolve_temp_batch_path,
    _resolve_temp_output_path,
    _resolve_temp_target,
    _subtitle_matches_video,
    _trim_video_segment,
    _downscale_video,
)
from .webvtt import _ensure_webvtt_for_video, _ensure_webvtt_variant, _write_webvtt
from .workers import _resolve_encoding_worker_count, _resolve_llm_worker_count, _resolve_worker_count

__all__ = [
    "DEFAULT_YOUTUBE_VIDEO_ROOT",
    "YoutubeDubbingService",
    "YoutubeNasSubtitle",
    "YoutubeNasVideo",
    "SubtitleDeletionResult",
    "delete_downloaded_video",
    "delete_nas_subtitle",
    "extract_inline_subtitles",
    "list_inline_subtitle_streams",
    "generate_dubbed_video",
    "list_downloaded_videos",
    "_apply_audio_gain_to_clip",
    "_apply_gap_audio_mix",
    "_ASS_TAG_PATTERN",
    "_AssDialogue",
    "_build_atempo_filters",
    "_build_job_result",
    "_build_subtitle_output_path",
    "_clamp_original_mix",
    "_classify_video_source",
    "_clip_dialogues_to_window",
    "_compute_pace_factor",
    "_compute_reference_rms",
    "_compute_underlay_gain_db",
    "_concat_video_segments",
    "_cues_to_dialogues",
    "_DEFAULT_FLUSH_SENTENCES",
    "_DEFAULT_ORIGINAL_MIX_PERCENT",
    "_DubJobCancelled",
    "_downscale_video",
    "_enforce_dialogue_gaps",
    "_ensure_webvtt_for_video",
    "_ensure_webvtt_variant",
    "_extract_translation",
    "_find_language_token",
    "_fit_segment_to_window",
    "_format_clip_suffix",
    "_format_time_prefix",
    "_GAP_MIX_MAX_PERCENT",
    "_GAP_MIX_SCALAR",
    "_has_audio_stream",
    "_has_video_stream",
    "_HTML_TAG_PATTERN",
    "_is_rtl_language",
    "_language_uses_non_latin",
    "_language_matches_filters",
    "_looks_all_caps",
    "_measure_active_window",
    "_merge_overlapping_dialogues",
    "_mirror_subtitle_to_source_dir",
    "_mix_with_original_audio",
    "_mux_audio_track",
    "_normalize_all_caps_cues",
    "_normalize_ass_line",
    "_normalize_language_hint",
    "_normalize_rtl_word_order",
    "_normalize_language_filters",
    "_pad_clip_to_duration",
    "_parse_ass_dialogues",
    "_parse_ass_timestamp",
    "_parse_batch_start_seconds",
    "_parse_dialogues",
    "_probe_duration_seconds",
    "_probe_subtitle_streams",
    "_probe_video_height",
    "_resolve_batch_output_path",
    "_resolve_encoding_worker_count",
    "_resolve_language_code",
    "_resolve_llm_worker_count",
    "_resolve_output_path",
    "_resolve_target_width",
    "_resolve_temp_batch_path",
    "_resolve_temp_output_path",
    "_resolve_temp_target",
    "_resolve_worker_count",
    "_sanitize_cue_markup",
    "_sanitize_for_tts",
    "_sanitize_subtitle_text",
    "_subtitle_codec_is_image_based",
    "_seconds_to_vtt_timestamp",
    "_sentence_case_line",
    "_serialize_generated_files",
    "_serialize_generated_files_batch",
    "_summarize_ffmpeg_error",
    "_SubtitleFileWriter",
    "_subtitle_matches_video",
    "_synthesise_track_from_ass",
    "_TARGET_DUB_HEIGHT",
    "_TEMP_DIR",
    "_time_stretch_to_duration",
    "_transliterate_text",
    "_validate_time_window",
    "_VIDEO_EXTENSIONS",
    "_write_webvtt",
    "_resolve_gap_mix_percent",
    "logger",
]
